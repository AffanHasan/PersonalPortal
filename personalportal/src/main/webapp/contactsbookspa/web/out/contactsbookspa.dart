// Auto-generated from contactsbookspa.html.
// DO NOT EDIT.

library contacts_book_spa;

import 'dart:html' as autogenerated;
import 'dart:svg' as autogenerated_svg;
import 'package:web_ui/web_ui.dart' as autogenerated;
import 'package:web_ui/observe/observable.dart' as __observe;
import 'dart:html';
import 'dart:json' as json;
import 'package:lib/cb_locale_data.dart' as cb_locale_data;
import 'package:web_ui/web_ui.dart';
import 'package:web_ui/watcher.dart' as watchers;
import 'package:json_object/json_object.dart';
import 'package:pp_commons/pp_common_ui.dart' as pp_comm_ui;
part '../add_contact.dart';


// Original code


/**
 * Holds the contacts book state
 */
JsonObject contactsBook = new JsonObject();
ButtonElement addGroupBtn = new ButtonElement();

String baseURL = "/personalportal/ContactsBook?action=";
bool showCCG = true;//Initially on application start up collapsable_contacts_grouping will be rendered
bool showCS = false;//contacts_search will be enabled only when user starts typing in the text bar

/**
 * Learn about the Web UI package by visiting
 * http://www.dartlang.org/articles/dart-web-components/.
 */
void main() {
  // Enable this to use Shadow DOM in the browser.
  //useShadowDom = true;
  
  //TODO : Render basic UI
  renderBasicUIOnFirstLoad();
  
  //TODO : Load initial data container
  print("--- calling loadDataContainerOnFirstLoad");
  loadDataContainerOnFirstLoad();
}

/**
 * To render the basic user interface div on application start up
 */
void renderBasicUIOnFirstLoad(){
  query("#application_header").appendHtml("<h1>" + cb_locale_data.getPropertyValue("contactsBook") +"</h1>");
  renderControlsPanelOnFirstLoad();
}

/**
 * To load the data_container div on application start up
 */
void loadDataContainerOnFirstLoad(){
  DivElement data_container = query("#data_container");
  HttpRequest.getString(baseURL + "getContactsGroupList").then(
      (String responseText){
        DetailsElement group = new DetailsElement();
        String groupName;
        List<String> jsonList = json.parse(responseText);//Server returns json list of contacts groups
        if(jsonList.isEmpty){//If no contacts in this book
        }
        else{
          for(int i = 0; i < jsonList.length; i++ ){
            groupName = jsonList[i].toString();
            contactsBook[groupName] = "";
            print("contactsBook.keys.length : " + contactsBook.keys.length.toString());
            group.id=groupName + "_group";
            HtmlElement summary = new Element.tag("summary");
            summary.text = groupName;
            summary.onClick.listen(
                (Event e){
                  if(contactsBook.containsKey(groupName)){
                  }else{
                    //Sending the GET request to the server
                    HttpRequest request = new HttpRequest();
                    List<JsonObject> contactsList;
                    // add an event handler that is called when the request finishes
                    HttpRequest.getString(baseURL + "getContactsListForAGroup" + "&" + "groupName=" + groupName).then(
                        (String responseText){
                          contactsList = json.parse(responseText);
                          query("#" + groupName + "_group").appendHtml("<ul id="+groupName + "_contacts_list"+"></ul>");
                          LIElement contactElement;
                          for(JsonObject contact in contactsList){
                            contactElement = new LIElement();
                            contactElement.appendText(contact["name"]);
                            contactElement.appendText(contact["comments"]);
                            query("#" + groupName + "_contacts_list").append(contactElement);
                          }
                          contactsBook[groupName] = contactsList;
                        }
                    );
                  }
                }
            );
            group.append(summary);
            query("#data_container").children.add(group);
            watchers.dispatch();
          }
        }
      }
  );
}

/**
 * To render the controls panel on application start up 
 */
void renderControlsPanelOnFirstLoad(){
  addContactBtn.text = "+";
  addContactBtn.title = cb_locale_data.getPropertyValue("addContact");
  addContactBtn.id = "add_contact_btn";
  addContactBtn.onClick.listen(
      (Event e){
        launchGeneralDialog();
        populateGeneralDialogForAddContact();
      }
  );
  query("#control_panel").append(addContactBtn);
  addGroupBtn.text = "âŠž";
  addGroupBtn.title = cb_locale_data.getPropertyValue("addGroup");
  addGroupBtn.id = "add_contacts_group";
  addGroupBtn.onClick.listen(
      (Event e){
        window.alert("Under construction");
      }
  );
  query("#control_panel").append(addGroupBtn);
}

/**
 * To launch the general dialog use this function and pass the type of action as string parameter
 */
void launchGeneralDialog(){
  query("#overlay_shield").style.display = "inline";
  query("#general_dialog").style.display = "inline";
}

void closeGeneralDialog(){
  query("#overlay_shield").style.display = "none";
  query("#general_dialog").style.display = "none";
  query("#general_dialog_header_content").innerHtml = "";
  query("#general_dialog_body").innerHtml = "";
  query("#general_dialog_footer").innerHtml = "";
}
// Additional generated code
void init_autogenerated() {
  var __root = autogenerated.document.body;
  final __html0 = new autogenerated.Element.tag('template'), __html1 = new autogenerated.Element.html('<details><summary></summary></details>');
  var __e4, __e5;
  var __t = new autogenerated.Template(__root);
  __e4 = __root.nodes[7].nodes[3];
  __t.conditional(__e4, () => showCCG, (__t) {
    var __e3;
    __e3 = __html0.clone(true);
    __t.loop(__e3, () => contactsBook.keys, ($list, $index, __t) {
      var key = $list[$index];
      var __e1, __e2;
      __e2 = __html1.clone(true);
      __e1 = __e2.nodes[0];
      var __binding0 = __t.contentBind(() => key, false);
      __e1.nodes.add(__binding0);
    __t.addAll([new autogenerated.Text('\n          '),
        __e2,
        new autogenerated.Text('\n        ')]);
    });
  __t.addAll([new autogenerated.Text('\n        '),
      __e3,
      new autogenerated.Text('\n      ')]);
  });

  __e5 = __root.nodes[11].nodes[1].nodes[3];
  __t.listen(__e5.onClick, ($event) { closeGeneralDialog(); });
  __t.create();
  __t.insert();
}

//@ sourceMappingURL=contactsbookspa.dart.map